services:
  # Next.js Application
  app:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: wms-app
    restart: unless-stopped
    ports:
      - "3000:3000"
    # PRODUCTION MODE: No volume mounts - uses built standalone image from Dockerfile
    # Volume mounts would overwrite the built files and cause "next: not found" errors
    # For development with hot-reload, uncomment volumes below and change command to "npm run dev"
    # volumes:
    #   - ./:/app
    #   - /app/node_modules
    #   - /app/.next
    env_file:
      - .env
    environment:
      DATABASE_URL: ${DATABASE_URL}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET:-$(openssl rand -base64 32)}
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3000}
      AUTH_TRUST_HOST: "true"
      NEXT_PUBLIC_COMPANY_NAME: ${NEXT_PUBLIC_COMPANY_NAME:-Fresh Farm Logic LLC}
      NEXT_PUBLIC_COMPANY_ADDRESS: ${NEXT_PUBLIC_COMPANY_ADDRESS:-1234 Produce Lane, Salinas, CA}
      # QuickBooks Online Integration
      QBO_CLIENT_ID: ${QBO_CLIENT_ID}
      QBO_CLIENT_SECRET: ${QBO_CLIENT_SECRET}
      QBO_REDIRECT_URI: ${QBO_REDIRECT_URI:-http://localhost:3000/api/auth/qbo/callback}
      QBO_ENVIRONMENT: ${QBO_ENVIRONMENT:-sandbox}
      NODE_ENV: production
      # New Relic APM Configuration
      NEW_RELIC_LICENSE_KEY: ${NEW_RELIC_LICENSE_KEY}
      NEW_RELIC_APP_NAME: ${NEW_RELIC_APP_NAME:-WMS-Production}
    # Use production build (standalone mode) - server.js is in the built image
    networks:
      - wms-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  # QuickBooks Auto-Sync Service
  qbo-sync:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: wms-qbo-sync
    restart: unless-stopped
    depends_on:
      - app
    env_file:
      - .env
    environment:
      DATABASE_URL: ${DATABASE_URL}
      NEXTAUTH_SECRET: ${NEXTAUTH_SECRET}
      NEXTAUTH_URL: ${NEXTAUTH_URL:-http://localhost:3000}
      AUTH_TRUST_HOST: "true"
      NEXT_PUBLIC_COMPANY_NAME: ${NEXT_PUBLIC_COMPANY_NAME:-Fresh Farm Logic LLC}
      NEXT_PUBLIC_COMPANY_ADDRESS: ${NEXT_PUBLIC_COMPANY_ADDRESS:-1234 Produce Lane, Salinas, CA}
      # QuickBooks Online Integration
      QBO_CLIENT_ID: ${QBO_CLIENT_ID}
      QBO_CLIENT_SECRET: ${QBO_CLIENT_SECRET}
      QBO_REDIRECT_URI: ${QBO_REDIRECT_URI:-http://localhost:3000/api/auth/qbo/callback}
      QBO_ENVIRONMENT: ${QBO_ENVIRONMENT:-sandbox}
      # Auto-sync configuration
      QBO_AUTO_SYNC_ENABLED: ${QBO_AUTO_SYNC_ENABLED:-false}
      QBO_SYNC_INTERVAL_MINUTES: ${QBO_SYNC_INTERVAL_MINUTES:-1}
      QBO_SYNC_CUSTOMERS: ${QBO_SYNC_CUSTOMERS:-true}
      QBO_SYNC_PRODUCTS: ${QBO_SYNC_PRODUCTS:-true}
      QBO_SYNC_VENDORS: ${QBO_SYNC_VENDORS:-true}
      QBO_SYNC_INVOICES: ${QBO_SYNC_INVOICES:-true}
      NODE_ENV: production
    command: ["npm", "run", "qbo-sync"]
    networks:
      - wms-network

  # New Relic Infrastructure Monitoring
  newrelic-infra:
    image: newrelic/infrastructure:latest
    container_name: wms-newrelic-infra
    restart: unless-stopped
    privileged: true
    network_mode: host
    pid: host
    volumes:
      - /:/host:ro
      - /var/run/docker.sock:/var/run/docker.sock
    environment:
      NRIA_LICENSE_KEY: ${NEW_RELIC_LICENSE_KEY}
    # Note: Infrastructure agent runs on host network to monitor actual server stats

networks:
  wms-network:
    driver: bridge

